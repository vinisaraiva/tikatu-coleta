<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Tikatu Coleta</title>
    <meta name="theme-color" content="#0066CC">
    <meta name="description" content="Sistema de Coleta de Dados de Qualidade da √Ågua">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tikatu Coleta">
    <link rel="icon" href="./favicon.ico" />
    <link rel="apple-touch-icon" href="./favicon.ico" />
    <link rel="manifest" href="./manifest.json" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
      }
      
      .container {
        max-width: 400px;
        width: 90%;
        background: white;
        border-radius: 20px;
        padding: 40px 30px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        text-align: center;
      }
      
      .logo {
        width: 80px;
        height: 80px;
        background: #0066CC;
        border-radius: 50%;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
      }
      
      .title {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #0066CC;
      }
      
      .subtitle {
        font-size: 14px;
        color: #666;
        margin-bottom: 30px;
        line-height: 1.4;
      }
      
      .form {
        margin-bottom: 30px;
      }
      
      .input {
        width: 100%;
        height: 50px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        padding: 0 15px;
        font-size: 16px;
        margin-bottom: 15px;
        transition: border-color 0.3s ease;
      }
      
      .input:focus {
        outline: none;
        border-color: #0066CC;
      }
      
      .button {
        width: 100%;
        height: 50px;
        background: #0066CC;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      
      .button:hover {
        background: #0052a3;
      }
      
      .button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      
      .info {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
      }
      
      .info-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #0066CC;
      }
      
      .info-text {
        font-size: 14px;
        color: #666;
        line-height: 1.4;
      }
      
      .dashboard {
        display: none;
      }
      
      .dashboard.active {
        display: block;
      }
      
      .welcome {
        font-size: 20px;
        margin-bottom: 20px;
        color: #0066CC;
      }
      
      .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 20px 0;
      }
      
      .stat {
        background: #f8fafc;
        padding: 15px;
        border-radius: 12px;
        text-align: center;
      }
      
      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #0066CC;
      }
      
      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      
      .loading {
        display: none;
        color: #0066CC;
        font-size: 14px;
        margin-top: 10px;
      }
      
      .error {
        display: none;
        color: #e53e3e;
        font-size: 14px;
        margin-top: 10px;
      }

      @media (max-width: 480px) {
        .container {
          padding: 30px 20px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Login Screen -->
      <div id="loginScreen">
        <div class="logo">T</div>
        <h1 class="title">Tikatu Coleta</h1>
        <p class="subtitle">Sistema de Coleta de Dados de Qualidade da √Ågua</p>
        
        <form class="form" id="loginForm">
          <input 
            type="text" 
            class="input" 
            id="code" 
            placeholder="C√≥digo do Volunt√°rio"
            required
          />
          <input 
            type="password" 
            class="input" 
            id="password" 
            placeholder="Senha"
            required
          />
          <button type="submit" class="button" id="loginButton">
            Entrar
          </button>
        </form>
        
        <div class="loading" id="loading">Carregando...</div>
        <div class="error" id="error"></div>
        
        <div class="info">
          <div class="info-title">üíß Ci√™ncia Cidad√£</div>
          <div class="info-text">
            A ci√™ncia cidad√£ se constr√≥i em muitas m√£os: sua coleta ajuda a revelar a qualidade da nossa √°gua.
          </div>
        </div>
      </div>

      <!-- Dashboard Screen -->
      <div id="dashboardScreen" class="dashboard">
        <div class="logo">T</div>
        <h1 class="title">Dashboard</h1>
        <p class="welcome" id="welcomeMessage">Bem-vindo!</p>
        
        <div class="stats">
          <div class="stat">
            <div class="stat-number" id="totalReadings">-</div>
            <div class="stat-label">Total de Coletas</div>
          </div>
          <div class="stat">
            <div class="stat-number" id="lastReading">-</div>
            <div class="stat-label">√öltima Coleta</div>
          </div>
        </div>
        
        <button class="button" id="logoutButton" style="margin-top: 20px;">
          Sair
        </button>
        
        <div class="info">
          <div class="info-title">üì± Use o App Android</div>
          <div class="info-text">
            Para funcionalidades completas, use a vers√£o Android do aplicativo.
          </div>
        </div>
      </div>
    </div>

    <script>
      // Simula√ß√£o do Supabase (em produ√ß√£o, use a API real)
      const SUPABASE_URL = 'https://oqkqbcuwkzcnhrnulpnl.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xa3FiY3V3a3pjbmhybnVscG5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk3ODI3OTksImV4cCI6MjA0NTM1ODc5OX0.g5Jzv0DFMF8JXkgGE4_xhx_-k2Q3dRBh8ry_6XdtW6U';

      // Elementos DOM
      const loginScreen = document.getElementById('loginScreen');
      const dashboardScreen = document.getElementById('dashboardScreen');
      const loginForm = document.getElementById('loginForm');
      const loginButton = document.getElementById('loginButton');
      const logoutButton = document.getElementById('logoutButton');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const welcomeMessage = document.getElementById('welcomeMessage');

      // Estado da aplica√ß√£o
      let currentUser = null;

      // Fun√ß√£o para mostrar loading
      function showLoading(show = true) {
        loading.style.display = show ? 'block' : 'none';
        loginButton.disabled = show;
        loginButton.textContent = show ? 'Carregando...' : 'Entrar';
      }

      // Fun√ß√£o para mostrar erro
      function showError(message) {
        error.textContent = message;
        error.style.display = 'block';
        setTimeout(() => {
          error.style.display = 'none';
        }, 5000);
      }

      // Fun√ß√£o para fazer login
      async function login(code, password) {
        try {
          const response = await fetch(`${SUPABASE_URL}/rest/v1/volunteers?code=eq.${code}&is_active=eq.true`, {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error('Erro na conex√£o com o servidor');
          }

          const data = await response.json();
          
          if (data.length === 0) {
            throw new Error('Volunt√°rio n√£o encontrado ou inativo');
          }

          const volunteer = data[0];
          
          // Verificar senha (Base64 decodificada)
          if (!volunteer.password_hash) {
            throw new Error('Volunt√°rio n√£o possui senha cadastrada');
          }

          const decodedPassword = atob(volunteer.password_hash);
          if (password !== decodedPassword) {
            throw new Error('Senha incorreta');
          }

          return volunteer;
        } catch (err) {
          throw new Error(err.message || 'Erro no login');
        }
      }

      // Fun√ß√£o para mostrar dashboard
      function showDashboard(user) {
        currentUser = user;
        welcomeMessage.textContent = `Bem-vindo, ${user.nome}!`;
        loginScreen.style.display = 'none';
        dashboardScreen.classList.add('active');
        
        // Salvar no localStorage
        localStorage.setItem('tikatu_user', JSON.stringify(user));
      }

      // Fun√ß√£o para mostrar login
      function showLogin() {
        currentUser = null;
        loginScreen.style.display = 'block';
        dashboardScreen.classList.remove('active');
        
        // Limpar localStorage
        localStorage.removeItem('tikatu_user');
      }

      // Event listeners
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const code = document.getElementById('code').value.trim();
        const password = document.getElementById('password').value.trim();
        
        if (!code || !password) {
          showError('Por favor, preencha todos os campos');
          return;
        }

        showLoading(true);
        
        try {
          const user = await login(code, password);
          showDashboard(user);
        } catch (err) {
          showError(err.message);
        } finally {
          showLoading(false);
        }
      });

      logoutButton.addEventListener('click', () => {
        showLogin();
      });

      // Verificar se j√° est√° logado
      window.addEventListener('load', () => {
        const savedUser = localStorage.getItem('tikatu_user');
        if (savedUser) {
          try {
            const user = JSON.parse(savedUser);
            showDashboard(user);
          } catch (err) {
            showLogin();
          }
        }
      });

      // Registrar Service Worker para PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }
    </script>
  </body>
</html>